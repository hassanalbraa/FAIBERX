/**
 * This ruleset enforces a Role-Based Access Control (RBAC) model.
 *
 * Core Philosophy:
 * Access is primarily determined by a user's role. A user is considered an 'Admin'
 * if a corresponding document exists for them in the `/roles_admin` collection.
 * This approach centralizes role management and simplifies security logic.
 *
 * Data Structure:
 * - /products/{productId}: A top-level collection containing all product data.
 * - /roles_admin/{userId}: A collection where the existence of a document
 *   with a user's UID as the ID grants them administrative privileges.
 *
 * Key Security Decisions:
 * - Admin-Only Writes: All write operations (create, update, delete) on products
 *   are strictly limited to authenticated users with the 'Admin' role.
 * - Public Reads: Any user (authenticated or not) can read individual product
 *   documents (`get`) and the entire collection of products (`list`).
 * - Locked Admin Roles: The `/roles_admin` collection is not writeable from the
 *   client. This is a critical security measure ensuring that admin roles can only
 *   be assigned through the Firebase Console or a trusted server-side process.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user has an admin role.
     * This is determined by the existence of a document in the /roles_admin
     * collection matching the user's UID. This function performs one read.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description
     *   Manages product data. All users can read products, but only Admins
     *   can create, update, or delete them.
     * @path /products/{productId}
     * @allow (read) Any user, signed in or not, can fetch a single product or a list of products.
     * @allow (write) An Admin user can perform all write operations.
     * @deny (write) A regular signed-in user or anonymous user cannot write products.
     * @principle
     *   Implements public read access while restricting writes to privileged roles (Admins).
     */
    match /products/{productId} {
      allow read: true;
      allow write: if isAdmin();
    }

    /**
     * @description
     *   Defines which users are administrators. The existence of a document
     *   grants the role. This collection is read-only from the client.
     * @path /roles_admin/{adminId}
     * @allow (N/A) No client-side operations are permitted.
     * @deny (create) A user cannot make themselves an admin.
     * @deny (delete) An admin cannot revoke their own or another's admin status.
     * @principle
     *   Enforces a "locked down" security model for critical role-management
     *   data, requiring changes to be made from a trusted environment like the
     *   Firebase Console or a backend server.
     */
    match /roles_admin/{adminId} {
      allow read, write: if false;
    }
  }
}
