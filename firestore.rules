/**
 * This ruleset enforces a Role-Based Access Control (RBAC) model.
 *
 * Core Philosophy:
 * Access is primarily determined by a user's role. A user is considered an 'Admin'
 * if their email is 'admin@example.com'.
 * Regular users have rights to their own data in the `/users` collection.
 * This approach centralizes role management and simplifies security logic.
 *
 * Data Structure:
 * - /products/{productId}: A top-level collection containing all product data.
 * - /roles_admin/{userId}: A collection where the existence of a document
 *   with a user's UID as the ID grants them administrative privileges. (DEPRECATED by email check)
 * - /users/{userId}: Stores profile information for individual users.
 *
 * Key Security Decisions:
 * - Admin-Only Product Writes: All write operations (create, update, delete) on products
 *   are strictly limited to authenticated users with the 'Admin' role.
 * - Public Product Reads: Any user (authenticated or not) can read the entire collection of products.
 * - User-Owned Profiles: Users can create, read, and update their own document in the `/users` collection.
 *   They cannot access anyone else's data.
 * - Admin User Management: Admins can list, read, and update any user's profile (e.g., to ban them).
 * - Locked Admin Roles: The `/roles_admin` collection is not writeable from the
 *   client. This is a critical security measure ensuring that admin roles can only
 *   be assigned through the Firebase Console or a trusted server-side process.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user has an admin role.
     * This is determined by their email address.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'admin@example.com';
    }
    
    /**
     * Checks if the requesting user is the owner of the document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description
     *   Manages product data. All users can read products, but only Admins
     *   can create, update, or delete them.
     */
    match /products/{productId} {
      allow list, get: if true;
      allow write: if isAdmin();
    }

    /**
     * @description
     *   Manages user profile data. Users can only access and modify their own data.
     *   Admins can read all user data and update it (e.g. for banning).
     */
    match /users/{userId} {
      allow create: if isSignedIn();
      allow get, update: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
    }

    /**
     * @description
     *   Defines which users are administrators. The existence of a document
     *   grants the role. This collection is read-only from the client.
     */
    match /roles_admin/{adminId} {
      allow read, write: if false;
    }
  }
}
