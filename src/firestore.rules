/**
 * This ruleset enforces a Role-Based Access Control (RBAC) model.
 *
 * Core Philosophy:
 * Access is primarily determined by a user's role. A user is considered an 'Admin'
 * if their email is 'admin@example.com'.
 * Regular users have rights to their own data in the `/users` collection.
 * This approach centralizes role management and simplifies security logic.
 *
 * Data Structure:
 * - /products/{productId}: A top-level collection containing all product data.
 * - /roles_admin/{userId}: A collection where the existence of a document
 *   with a user's UID as the ID grants them administrative privileges. (DEPRECATED by email check)
 * - /users/{userId}: Stores profile information for individual users.
 * - /users/{userId}/addresses/{addressId}: Stores a user's saved shipping addresses.
 * - /orders/{orderId}: Stores customer orders.
 *
 * Key Security Decisions:
 * - Admin-Only Product Writes: All write operations (create, update, delete) on products
 *   are strictly limited to authenticated users with the 'Admin' role.
 * - Public Product Reads: Any user (authenticated or not) can read the entire collection of products.
 * - User-Owned Profiles & Addresses: Users can create, read, update, and delete their own documents.
 *   They cannot access anyone else's data.
 * - Admin User Management: Admins can read and update any user's profile (e.g., to ban them).
 * - Orders: Users can create their own orders and read them. Admins have full read/write access to all orders.
 * - Locked Admin Roles: The `/roles_admin` collection is not writeable from the
 *   client. This is a critical security measure ensuring that admin roles can only
 *   be assigned through the Firebase Console or a trusted server-side process.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the requesting user has an admin role.
     * This is determined by their email address.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.token.email == 'admin@example.com';
    }
    
    /**
     * Checks if the requesting user is the owner of the document.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description
     *   Manages product data. All users can read products, but only Admins
     *   can create, update, or delete them.
     */
    match /products/{productId} {
      allow list, get: if true;
      allow write: if isAdmin();
    }

    /**
     * @description
     *   Manages user-specific data, including profiles and saved addresses.
     */
    match /users/{userId} {
      /**
       * Manages user profile data. Users can only access and modify their own data.
       * Admins can read all user data and update it (e.g. for banning).
       */
      allow create: if isSignedIn();
      allow get, update: if isOwner(userId) || isAdmin();
      
      /**
       * @description
       *   Manages a user's saved shipping addresses. A user can fully control their own
       *   address book, but cannot access anyone else's.
       *   `read` covers both `get` and `list`. `write` covers `create`, `update`, `delete`.
       *   The rule ensures the authenticated user's UID matches the {userId} in the path.
       */
      match /addresses/{addressId} {
        allow read, write: if isOwner(userId);
      }
    }
    
    /**
     * @description
     *   Manages order data.
     *   - Admins have full read/write access.
     *   - Authenticated users can create their own orders.
     *   - Users can only read their own orders (individually or as a list).
     */
    match /orders/{orderId} {
      // Admins can perform any write operation.
      allow write: if isAdmin();

      // Users can create their own orders. The incoming document's userId must match the user's uid.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;

      // Admins can read any individual order.
      // Users can only read an order they own (the saved document's userId must match user's uid).
      allow get: if isAdmin() || (isSignedIn() && resource.data.userId == request.auth.uid);
      
      // Rules are not filters: This rule allows a user to query the orders collection.
      // 1. Admins can list all orders without any constraints.
      // 2. Regular users can list orders ONLY IF they filter by their own userId.
      //    This also permits ordering the query, which is required by the app.
      allow list: if isAdmin() || (isSignedIn() && request.query.where.userId == request.auth.uid);
    }
    
    match /users_admin/{adminId} {
        allow read, list: if isAdmin();
    }

    /**
     * @description
     *   Defines which users are administrators. The existence of a document
     *   grants the role. This collection is read-only from the client.
     */
    match /roles_admin/{adminId} {
      allow read, write: if false;
    }
  }
}
